<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Boostrap CSS -->
    <link rel="stylesheet" href="./css/libs/bootstrap.min.css">
    <script src="./js/libs/vue.min.js"></script>
    <script type="text/javascript" src="./eel.js"></script>
    <script src="./js/libs/jquery-3.5.1.min.js"></script>
    <script src="./js/libs/popper.min.js"></script>
    <script src="./js/libs/bootstrap.min.js"></script>
    <script src="./js/libs/d3.min.js"></script>

    <title>BJL模擬Ver2</title>
    <style>
    </style>

</head>

<body>
    <nav class="navbar navbar-expand navbar-dark bg-dark">
        <a class="navbar-brand" href="#">百家樂模擬</a>
    </nav>
    <div id="app" class="container-fluid" style="margin-top: 20px;">

        <div class="row" style="margin: 20px 0">
            <div class="col-2">
                <button id="starts" class="btn btn-primary" v-on:click="getData" style="width: 100%">模擬大路</button>
            </div>
        </div>

        <div v-if="!isLoading" id="road-container">

            <div class="row">
                <div class="col-7" id="road-holder" style="margin-bottom: 20px;"></div>
            </div>

        </div>

    </div>



    <script>
        var app = new Vue({
            el: '#app',
            data: {
                multiRoads: {},
                realCards: [],
                isLoading: true,
                maxX: 40,
                maxY: 15
            },
            methods: {
                getData: function () {
                    let self = this;
                    self.isLoading = true
                    self.isLoading = false

                    var roadContainer = d3.select('#road-holder')
                    roadContainer.selectAll('*').remove();

                    eel.getMultiRoad()()
                        .then(res => {
                            self.multiRoads = res.multiRoad.roads;
                            self.realCards = res.realCards;
                            self.maxX = res.multiRoad.maxX;
                            self.maxY = res.multiRoad.maxY + 3;
                        })
                        .catch(error => {
                            self.isLoading = true
                            console.log(error)
                        })
                        .finally(() => {
                            self.isLoading = false
                        })
                },
                plotRoad: function (rc, svgNumber) {
                    let self = this;

                    const xAxisRange = [...Array(self.maxX).keys()];
                    const yAxisRange = [...Array(self.maxY).keys()];

                    const margin = {
                        top: 20,
                        right: 20,
                        bottom: 20,
                        left: 30
                    }

                    const circleR = 12

                    const width = 800;
                    const height = 300;

                    const innerWidth = width - margin.left - margin.right;
                    const innerHeight = height - margin.top - margin.bottom;


                    svgCheck = document.getElementById(`road${svgNumber}`)

                    if (svgCheck === null) {
                        var svg = d3.select('#road-holder')
                            .append('svg')
                            .attr('id', `road${svgNumber}`)
                            .attr('width', self.maxX * circleR * 2 * 1.1)
                            .attr('height', 300);

                    } else {
                        var svg = d3.select(`road${svgNumber}`);
                        
                    }

                    svg.selectAll("*").remove();

                    self.chart = svg.append('g')
                        .attr('transform', `translate(${margin.left}, 0)`);

                    const roads = svg.selectAll('roadCell')
                        .data(rc)
                        .enter().append('circle')
                        .attr('cx', d => (d.x + 1) * circleR * 2)
                        .attr('cy', d => (d.y + 1) * circleR * 2)
                        .attr('r', circleR)
                        .style('fill', d => d.fill)
                        .style('stroke', 'solid')
                        .style('stroke-color', d => d.fill);


                    const squares = svg.selectAll('sqCell')
                        .data(self.tableGrid)
                        .enter().append('rect')
                        .attr('x', d => (d.x + 0.5) * circleR * 2)
                        .attr('y', d => (d.y + 0.5) * circleR * 2)
                        .attr('width', circleR * 2)
                        .attr('height', circleR * 2)
                        .style('fill', "None")
                        .style('stroke', 'black')
                        .style('stroke-widht', '1px')


                }

            },
            computed: {
                tableGrid: function() {
                    let self = this;

                    var tableGrid = []
                    for (var i =1; i < self.maxX+1; i++){
                        for (var j = 1; j < self.maxY; j++){
                            tableGrid.push({
                                x: i,
                                y: j
                            })
                        }
                    }

                    return tableGrid
                }
            },
            mounted: function () {

            },
            watch: {
                multiRoads: function(newVal, oldVal) {
                    let self = this;
                    for (var temp in self.multiRoads){
                        self.plotRoad(self.multiRoads[temp]['maps']['result'], temp)
                    }
                }

            }

        })
    </script>



</body>

</html>